<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>I kanban haz bugs | Kanbu.gs</title>
  <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen"/>
  <link href="css/styles.css" rel="stylesheet" media="screen"/>
</head>
<body>

  <h1>Kanbu.gs</h1> <h2>Product</h2>
  <h3>Selected</h3>
  <ul id="selected">
  </ul>
  <h3>Analysis</h3>
  <ul id="analysis">
  </ul>
  <h3>Story</h3>
  <ul id="story">
  </ul>
  <h3>Implement</h3>
  <ul id="implement">
  </ul>
  <h3>Review</h3>
  <ul id="review">
  </ul>
  <h3>Test</h3>
  <ul id="test">
  </ul>
  <h3>Released</h3>
  <ul id="released">
  </ul>


  <script src="lib/jquery-1.8.3.min.js"></script>
  <script src="lib/underscore-min.js"></script>
  <script src="lib/bootstrap/js/bootstrap.min.js"></script>
  <script src="lib/bz.js"></script>
  <script>
    var ghBugs = [],
        bzBugs = [];

    var loadGhBugs = function(data) {
      _.each(data, function(pull){
        var bugRE = /fix bug (\d+)/;
        var bugArray = bugRE.exec(pull.title);
        if (bugArray && typeof(bugArray[1]) != undefined) {
          console.log("Pull " + pull.number + " fixes bug " + bugID);
          var bugID = bugArray[1];
          var ghBug = {id: bugID, state: pull.state, merged_at: pull.merged_at};
          console.log('ghBug: ' + JSON.stringify(ghBug));
          ghBugs.push(ghBug);
        }
      });
    };

    var processBzBugs = function(data) {
      _.each(data.bugs, function(bug){
        var li = "<li>" + bug.summary + "</li>";
        var $storyList = $('ul#story');
        var $implementList = $('ul#implement');
        var $reviewList = $('ul#review');
        var $testList = $('ul#test');
        var $releasedList = $('ul#released');
        if (bug.status == 'VERIFIED') {
          $releasedList.append(li);
        } else if (bug.status == 'RESOLVED') {
          $testList.append(li);
        } else if (_.contains(_.pluck(ghBugs, 'id'), bug.id.toString())){
          $reviewList.append(li);
        } else if (bug.assigned_to.name) {
          $implementList.append(li);
        } else {
          var $selectedList = $('ul#selected');
          $selectedList.append(li);
        }
        console.log("Bug " + bug.id);
      });
    };

    // Get MDN pull requests from GitHub
    var gettingPulls = $.getJSON("https://api.github.com/repos/mozilla/kuma/pulls", {
                client_id: '6f879db8324dca8c26f1',
                client_secret: 'da455accd2ff34dbbc52697c7649f49b717ec98d'
                })

    gettingPulls.done(loadGhBugs);


    gettingPulls.done(function(){
      var bugzillaURL = "https://api-dev.bugzilla.mozilla.org/latest/bug" +
                      "?product=Mozilla%20Developer%20Network" +
                      "&include_fields=id,summary,component,creation_time,creator,status,resolution,whiteboard,assigned_to,depends_on,blocks" +
                      "&whiteboard=kanbugs";
      var gettingBugs = $.getJSON(bugzillaURL)

      gettingBugs.done(processBzBugs);
    });

  </script>
</body>
</html>
